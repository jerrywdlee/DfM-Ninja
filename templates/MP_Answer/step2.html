<% const uid=new Date().getTime(); %>
    <div id="EmailAnswer_step2-<%=uid%>"
        class="bg-emerald-50 p-6 rounded-xl border border-emerald-100 shadow-inner relative">

        <!-- Action Buttons -->
        <div class="absolute top-4 right-6 flex gap-1.5 focus-within:ring-0">
            <button title="ãƒªã‚»ãƒƒãƒˆ"
                class="text-xs hover:bg-emerald-200/50 p-1.5 rounded-lg transition-all active:scale-90 flex items-center justify-center bg-white/50 border border-emerald-200/50 shadow-sm">ğŸ”„</button>
            <button title="ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°"
                class="text-xs hover:bg-emerald-200/50 p-1.5 rounded-lg transition-all active:scale-95 flex items-center justify-center bg-white/50 border border-emerald-200/50 shadow-sm">âš¡ï¸</button>
            <button title="ãƒ¡ãƒ¼ãƒ«æ–‡é¢ã‚³ãƒ”ãƒ¼"
                class="text-xs hover:bg-emerald-200/50 p-1.5 rounded-lg transition-all active:scale-95 flex items-center justify-center bg-white/50 border border-emerald-200/50 shadow-sm">âœ‰ï¸</button>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-2 gap-6 mt-6">
            <!-- Left Column -->
            <div class="flex flex-col gap-4">
                <!-- Email Head -->
                <div class="flex flex-col">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h4 class="text-[12px] font-black text-emerald-800 tracking-widest opacity-80">Email Head</h4>
                    </div>
                    <div name="emailHead" data-doubleclick="copy" contenteditable="true"
                        class="w-full h-[120px] p-3 text-xs font-mono border border-emerald-200 rounded-xl bg-white shadow-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/20 transition-all overflow-y-auto whitespace-pre-wrap outline-none"
                        placeholder="å®›å…ˆã‚„ã”æŒ¨æ‹¶ãªã©..."></div>
                </div>

                <!-- Email æœ¬æ–‡ -->
                <div class="flex flex-col flex-1">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h4 class="text-[12px] font-black text-emerald-800 tracking-widest opacity-80">Email æœ¬æ–‡</h4>
                    </div>
                    <div name="emailBody" data-doubleclick="copy" contenteditable="true"
                        class="w-full h-[240px] p-4 text-xs font-mono border border-emerald-200 rounded-xl bg-white shadow-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/20 transition-all overflow-y-auto whitespace-pre-wrap outline-none"
                        placeholder="ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡..."></div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="flex flex-col gap-4">
                <!-- To -->
                <div class="flex flex-col">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h4 class="text-[12px] font-black text-emerald-800 tracking-widest opacity-80">To:</h4>
                    </div>
                    <input type="text" name="emailTo" data-doubleclick="copy"
                        class="w-full p-3 text-xs font-mono border border-emerald-200 rounded-xl bg-white shadow-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/20 transition-all focus:bg-white"
                        placeholder="To..." />
                </div>

                <!-- CC -->
                <div class="flex flex-col">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h4 class="text-[12px] font-black text-emerald-800 tracking-widest opacity-80">CC:</h4>
                    </div>
                    <input type="text" name="emailCc" data-doubleclick="copy"
                        class="w-full p-3 text-xs font-mono border border-emerald-200 rounded-xl bg-white shadow-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/20 transition-all focus:bg-white"
                        placeholder="CC..." />
                </div>

                <!-- ä»¶å -->
                <div class="flex flex-col">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h4 class="text-[12px] font-black text-emerald-800 tracking-widest opacity-80">ä»¶å:</h4>
                    </div>
                    <input type="text" name="emailSubject" data-doubleclick="copy"
                        class="w-full p-3 text-xs font-mono border border-emerald-200 rounded-xl bg-white shadow-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/20 transition-all focus:bg-white"
                        placeholder="ä»¶å..." />
                </div>

                <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦è«‹ -->
                <div class="flex flex-col flex-1">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h4 class="text-[12px] font-black text-emerald-800 tracking-widest opacity-80">ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦è«‹:</h4>
                    </div>
                    <textarea name="reviewRequest" data-doubleclick="copy"
                        class="h-full w-full min-h-[120px] p-4 text-xs font-mono border border-emerald-200 rounded-xl bg-white shadow-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/20 transition-all resize-none"
                        placeholder="ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‹…å½“è€…ã¸ã®ä¾é ¼æ–‡..."></textarea>
                </div>
            </div>
        </div>

        <noscript data-name="emailSubject">
            [TL review][MP][{{Lic_L}}] {{caseNum}} {{caseTitle}}
        </noscript>

        <noscript data-name="emailHead">
            {{mailToNames}}

            ãŠç–²ã‚Œæ§˜ã§ã™ã€ {{familyName}} ã§ã™ã€‚

            TL review ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
            æœ¬å›ç­”ã§ã™ã€‚

            [Next C]
            {{currentNC_S}}

            [ãŠå•ã„åˆã‚ã›ç•ªå·]
            {{caseNum}}

            [ã‚¿ã‚¤ãƒˆãƒ«]
            {{caseTitle}}

            [ãŠå•ã„åˆã‚ã›å†…å®¹]
            {{custStatement}}
        </noscript>

        <noscript data-name="emailBody">
            ã”æ‹…å½“è€… æ§˜

            ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚{{CompanyName}} ã® {{nameWithKana}} ã§ã™ã€‚

            æœ¬ãƒ¡ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã®ãŠå•ã„åˆã‚ã›ã«é–¢ã™ã‚‹ã”é€£çµ¡ã«ãªã‚Šã¾ã™ã€‚

            [ãŠå•ã„åˆã‚ã›ç•ªå·]
            {{caseNum}}

            [ã‚¿ã‚¤ãƒˆãƒ«]
            {{caseTitle}}

            [å›ç­”]

            å¹³ç´ ã‚ˆã‚Šå¼Šç¤¾è£½å“ã‚’ã”æ„›é¡§ã„ãŸã ãã€èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
            ãŠå•ã„åˆã‚ã›ã„ãŸã ã„ãŸä»¶ã«ã¤ãã¾ã—ã¦ã€ä»¥ä¸‹ã«å›ç­”ã‚’è¨˜è¼‰ã„ãŸã—ã¾ã™ã€‚

            {{answerText}}

            ã”ä¸æ˜ç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠç”³ã—ä»˜ã‘ãã ã•ã„ã€‚
            ä»Šå¾Œã¨ã‚‚ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

            [æ¬¡å›ã”é€£çµ¡æ—¥ç¨‹]
            ã”é€£çµ¡ãŒç„¡ã„å ´åˆã§ã‚‚ã€{{nextNC_XL}} ã‚’ç›®é€”ã«æ”¹ã‚ã¦ã”é€£çµ¡ã‚’ã•ã›ã¦é ‚ãäºˆå®šã§ã”ã–ã„ã¾ã™ã€‚
            å¼•ãç¶šãã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

            {{footerNormal}}
        </noscript>

        <noscript data-name="emailTo">
            {{mailTo}}
        </noscript>

        <noscript data-name="emailCc">
            {{mailCc}}
        </noscript>

        <noscript data-name="reviewRequest">
            @ ã•ã‚“ã€ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
            TL review ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            [{{Lic_L}}] {{caseNum}} {{caseTitle}}
            QuickACKå¾Œã®æœ¬å›ç­”ã§ã™
            [Next C] {{currentNC_S}}
        </noscript>

        <script>
            (function () {
                const divId = '#EmailAnswer_step2-<%=uid%>';
                const $scope = $(divId); // ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ç¯„å›²å†…ã ã‘ã§æ¢ã™
                const $emailHead = $scope.find('[name="emailHead"]');
                const $emailBody = $scope.find('[name="emailBody"]');
                const $emailTo = $scope.find('input[name="emailTo"]');
                const $emailCc = $scope.find('input[name="emailCc"]');
                const $emailSubject = $scope.find('input[name="emailSubject"]');
                const $reviewRequest = $scope.find('textarea[name="reviewRequest"]');

                const emailHeadText = $scope.find('noscript[data-name="emailHead"]').text().trim().replace(/\n +/g, '\n');
                const emailBodyText = $scope.find('noscript[data-name="emailBody"]').text().trim().replace(/\n +/g, '\n');
                const emailSubjectText = $scope.find('noscript[data-name="emailSubject"]').text().trim().replace(/\n +/g, '\n');
                const emailToText = $scope.find('noscript[data-name="emailTo"]').text().trim().replace(/\n +/g, '\n');
                const emailCcText = $scope.find('noscript[data-name="emailCc"]').text().trim().replace(/\n +/g, '\n');
                const reviewRequestText = $scope.find('noscript[data-name="reviewRequest"]').text().trim().replace(/\n +/g, '\n');

                const caseDataInitial = window.currentCase;
                const autoLink = window.autoLinkUrls || ((text) => text);
                const activeStepInitial = caseDataInitial?.activeStep;

                if (activeStepInitial && activeStepInitial.emailHead) {
                    if ($emailHead.is('textarea, input')) $emailHead.val(activeStepInitial.emailHead); else $emailHead.html(autoLink(activeStepInitial.emailHead));
                } else if (caseDataInitial) {
                    const renderedEmailHead = caseDataInitial.render(emailHeadText);
                    if ($emailHead.is('textarea, input')) $emailHead.val(renderedEmailHead); else $emailHead.html(autoLink(renderedEmailHead));
                }
                if (activeStepInitial && activeStepInitial.emailBody) {
                    if ($emailBody.is('textarea, input')) $emailBody.val(activeStepInitial.emailBody); else $emailBody.html(autoLink(activeStepInitial.emailBody));
                } else if (caseDataInitial) {
                    const renderedEmailBody = caseDataInitial.render(emailBodyText);
                    if ($emailBody.is('textarea, input')) $emailBody.val(renderedEmailBody); else $emailBody.html(autoLink(renderedEmailBody));
                }
                if (activeStepInitial && activeStepInitial.emailTo) {
                    $emailTo.val(activeStepInitial.emailTo);
                } else if (caseDataInitial) {
                    const renderedEmailTo = caseDataInitial.render(emailToText);
                    $emailTo.val(renderedEmailTo);
                }
                if (activeStepInitial && activeStepInitial.emailCc) {
                    $emailCc.val(activeStepInitial.emailCc);
                } else if (caseDataInitial) {
                    const renderedEmailCc = caseDataInitial.render(emailCcText);
                    $emailCc.val(renderedEmailCc);
                }
                if (activeStepInitial && activeStepInitial.emailSubject) {
                    $emailSubject.val(activeStepInitial.emailSubject);
                } else if (caseDataInitial) {
                    const renderedEmailSubject = caseDataInitial.render(emailSubjectText);
                    $emailSubject.val(renderedEmailSubject);
                }
                if (activeStepInitial && activeStepInitial.reviewRequest) {
                    $reviewRequest.val(activeStepInitial.reviewRequest);
                } else if (caseDataInitial) {
                    const renderedReviewRequest = caseDataInitial.render(reviewRequestText);
                    $reviewRequest.val(renderedReviewRequest);
                }

                // .on ã§ã¯ãªãã€ç›´æ¥è¦ç´ ã« .click ç­‰ã§ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹
                $scope.find('button[title="ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°"]').off('click').on('click', function () {
                    const caseData = window.currentCase;
                    if (!caseData) return;
                    
                    const headText = $emailHead.is('textarea, input') ? $emailHead.val() : $emailHead.html();
                    const bodyText = $emailBody.is('textarea, input') ? $emailBody.val() : $emailBody.html();
                    const subjectVal = $scope.find('input[name="emailSubject"]').val();
                    const reviewVal = $scope.find('textarea[name="reviewRequest"]').val();

                    const renderedEmailHead = caseData.render(headText);
                    const renderedEmailBody = caseData.render(bodyText);
                    const renderedEmailSubject = caseData.render(subjectVal);
                    const renderedReviewRequest = caseData.render(reviewVal);
                    const renderedEmailTo = caseData.render(emailToText);
                    const renderedEmailCc = caseData.render(emailCcText);

                    if ($emailHead.is('textarea, input')) $emailHead.val(renderedEmailHead); else $emailHead.html(autoLink(renderedEmailHead));
                    if ($emailBody.is('textarea, input')) $emailBody.val(renderedEmailBody); else $emailBody.html(autoLink(renderedEmailBody));
                    $emailSubject.val(renderedEmailSubject);
                    $reviewRequest.val(renderedReviewRequest);
                    $emailTo.val(renderedEmailTo);
                    $emailCc.val(renderedEmailCc);

                    console.log('emailHead', renderedEmailHead, 'emailBody', renderedEmailBody, 'emailSubject', renderedEmailSubject, 'reviewRequest', renderedReviewRequest);
                });

                $scope.find('button[title="ãƒªã‚»ãƒƒãƒˆ"]').off('click').on('click', function () {
                    const caseData = window.currentCase;
                    if (!confirm('ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                        return;
                    }

                    if ($emailHead.is('textarea, input')) $emailHead.val(emailHeadText); else $emailHead.html(autoLink(emailHeadText));
                    if ($emailBody.is('textarea, input')) $emailBody.val(emailBodyText); else $emailBody.html(autoLink(emailBodyText));
                    $scope.find('input[name="emailSubject"]').val(emailSubjectText);
                    $scope.find('textarea[name="reviewRequest"]').val(reviewRequestText);
                    $scope.find('input[name="emailTo"]').val(emailToText);
                    $scope.find('input[name="emailCc"]').val(emailCcText);
                });

                $scope.find('button[title="ãƒ¡ãƒ¼ãƒ«æ–‡é¢ã‚³ãƒ”ãƒ¼"]').off('click').on('click', async function () {
                    const cleanHtml = (html) => {
                        return html.replace(/<br\s*\/?>/gi, '\n')
                                   .replace(/<div[^>]*>/gi, '\n')
                                   .replace(/<\/div>/gi, '')
                                   .replace(/<p[^>]*>/gi, '\n')
                                   .replace(/<\/p>/gi, '')
                                   .replace(/&nbsp;/gi, ' ')
                                   .trim();
                    };

                    const emailHeadContent = $emailHead.is('textarea, input') ? $emailHead.val() : cleanHtml($emailHead.html());
                    const emailBodyContent = $emailBody.is('textarea, input') ? $emailBody.val() : cleanHtml($emailBody.html());

                    const separator = '\n\n========================================\n\n';
                    let emailContentHTML = emailHeadContent + separator + emailBodyContent;
                    emailContentHTML = emailContentHTML.replace(/\r?\n|\r/g, '<br>');
                    
                    try {
                        const blobHTML = new Blob([emailContentHTML], { type: 'text/html' });
                        
                        const tmpDiv = document.createElement('div');
                        tmpDiv.innerHTML = emailHeadContent + separator + emailBodyContent;
                        let blockText = tmpDiv.innerText;
                        blockText = blockText.replace(/^$/gm, ' ');
                        
                        const blobText = new Blob([blockText], { type: 'text/plain' });
                        const data = [new ClipboardItem({
                            'text/html': blobHTML,
                            'text/plain': blobText
                        })];

                        await navigator.clipboard.write(data);
                        alert('ãƒ¡ãƒ¼ãƒ«æ–‡é¢ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
                    } catch (err) {
                        console.error('Failed to copy: ', err);
                        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                });
            })();
        </script>
    </div>