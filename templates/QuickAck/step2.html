<% const uid=new Date().getTime(); %>
    <div id="quick-ack_step2-<%=uid%>"
        class="bg-emerald-50 p-6 rounded-xl border border-emerald-100 shadow-inner relative">

        <!-- Action Buttons -->
        <div class="absolute top-4 right-6 flex gap-1.5 focus-within:ring-0">
            <button title="ãƒªã‚»ãƒƒãƒˆ"
                class="text-xs hover:bg-emerald-200/50 p-1.5 rounded-lg transition-all active:scale-90 flex items-center justify-center bg-white/50 border border-emerald-200/50 shadow-sm">ğŸ”„</button>
            <button title="ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°"
                class="text-xs hover:bg-emerald-200/50 p-1.5 rounded-lg transition-all active:scale-95 flex items-center justify-center bg-white/50 border border-emerald-200/50 shadow-sm">âš¡ï¸</button>
            <button title="ãƒ¡ãƒ¼ãƒ«ä½œæˆ"
                class="text-xs hover:bg-emerald-200/50 p-1.5 rounded-lg transition-all active:scale-95 flex items-center justify-center bg-white/50 border border-emerald-200/50 shadow-sm">âœ‰ï¸</button>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-2 gap-6 mt-6">
            <!-- Left Column -->
            <div class="flex flex-col gap-4">
                <!-- Email Head -->
                <div class="flex flex-col">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h4 class="text-[12px] font-black text-emerald-800 tracking-widest opacity-80">Email Head</h4>
                    </div>
                    <textarea name="emailHead" data-doubleclick="copy"
                        class="w-full h-[120px] p-3 text-xs font-mono border border-emerald-200 rounded-xl bg-white shadow-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/20 transition-all resize-none"
                        placeholder="å®›å…ˆã‚„ã”æŒ¨æ‹¶ãªã©..."></textarea>
                </div>

                <!-- Email æœ¬æ–‡ -->
                <div class="flex flex-col flex-1">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h4 class="text-[12px] font-black text-emerald-800 tracking-widest opacity-80">Email æœ¬æ–‡</h4>
                    </div>
                    <textarea name="emailBody" data-doubleclick="copy"
                        class="w-full h-[240px] p-4 text-xs font-mono border border-emerald-200 rounded-xl bg-white shadow-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/20 transition-all resize-none"
                        placeholder="ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡..."></textarea>
                </div>
            </div>

            <!-- Right Column -->
            <div class="flex flex-col gap-4">
                <!-- To -->
                <div class="flex flex-col">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h4 class="text-[12px] font-black text-emerald-800 tracking-widest opacity-80">To:</h4>
                    </div>
                    <input type="text" name="emailTo" data-doubleclick="copy"
                        class="w-full p-3 text-xs font-mono border border-emerald-200 rounded-xl bg-white shadow-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/20 transition-all focus:bg-white"
                        placeholder="To..." />
                </div>

                <!-- CC -->
                <div class="flex flex-col">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h4 class="text-[12px] font-black text-emerald-800 tracking-widest opacity-80">CC:</h4>
                    </div>
                    <input type="text" name="emailCc" data-doubleclick="copy"
                        class="w-full p-3 text-xs font-mono border border-emerald-200 rounded-xl bg-white shadow-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/20 transition-all focus:bg-white"
                        placeholder="CC..." />
                </div>

                <!-- ä»¶å -->
                <div class="flex flex-col">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h4 class="text-[12px] font-black text-emerald-800 tracking-widest opacity-80">ä»¶å:</h4>
                    </div>
                    <input type="text" name="emailSubject" data-doubleclick="copy"
                        class="w-full p-3 text-xs font-mono border border-emerald-200 rounded-xl bg-white shadow-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/20 transition-all focus:bg-white"
                        placeholder="ä»¶å..." />
                </div>

                <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦è«‹ -->
                <div class="flex flex-col flex-1">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <h4 class="text-[12px] font-black text-emerald-800 tracking-widest opacity-80">ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦è«‹:</h4>
                    </div>
                    <textarea name="reviewRequest" data-doubleclick="copy"
                        class="h-full w-full min-h-[120px] p-4 text-xs font-mono border border-emerald-200 rounded-xl bg-white shadow-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400/20 transition-all resize-none"
                        placeholder="ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‹…å½“è€…ã¸ã®ä¾é ¼æ–‡..."></textarea>
                </div>
            </div>
        </div>

        <noscript data-name="emailSubject">
            [TL review][MP][{{Lic_L}}] {{caseNum}} {{caseTitle}}
        </noscript>

        <noscript data-name="emailHead">
            {{mailToNames}}

            ãŠç–²ã‚Œæ§˜ã§ã™ã€ {{familyName}} ã§ã™ã€‚

            TL review ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
            QuickACKã§ã™ã€‚ (SLA: {{SLA}})

            [Next C]
            {{nextNC_S}}

            [ãŠå•ã„åˆã‚ã›ç•ªå·]
            {{caseNum}}

            [ã‚¿ã‚¤ãƒˆãƒ«]
            {{caseTitle}}

            [ãŠå•ã„åˆã‚ã›å†…å®¹]
            {{custStatement}}
        </noscript>

        <noscript data-name="emailBody">
            ã”æ‹…å½“è€… æ§˜

            ã“ã®åº¦ã¯ã€ãŠå•ã„åˆã‚ã›ã„ãŸã ãã¾ã—ã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
            æœ¬ä»¶ã«ã¤ãã¾ã—ã¦ã¯ã€{{CompanyAndSection}}ã® {{nameWithKana}} ãŒæ‹…å½“ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

            [ãŠå•ã„åˆã‚ã›ç•ªå·]
            {{caseNum}}

            [ã‚¿ã‚¤ãƒˆãƒ«]
            {{caseTitle}}

            [ãŠå•ã„åˆã‚ã›å†…å®¹]
            {{custStatement}}

            [ã”ç”¨å‘½äº‹é …]
            {{detailConfirm}}

            [èª¿æŸ»æ–¹é‡]
            å…ˆã«ç”³ã—ä¸Šã’ã¾ã—ãŸèªè­˜ã«åŸºã¥ãã€å¼Šç¤¾ãŒé–‹ç¤ºã—ã¦ãŠã‚Šã¾ã™å…¬é–‹æƒ…å ±ãªã‚‰ã³ã«ã€
            å¼Šç¤¾ã«ã¦ä¿æœ‰ã—ã¦ãŠã‚Šã¾ã™éå»ã®äº‹ä¾‹ã‚’å‚ç…§ã®ã†ãˆã€æ…é‡ã«èª¿æŸ»ã‚’é€²ã‚ãŸã†ãˆã§ã”å›ç­”ç”³ã—ä¸Šã’ãŸãå­˜ã˜ã¾ã™ã€‚

            èª ã«æã‚Œå…¥ã‚Šã¾ã™ãŒã€èª¿æŸ»ã«ã¯ä¸€å®šã®ãŠæ™‚é–“ã‚’é ‚æˆ´ã™ã‚‹å¯èƒ½æ€§ãŒã”ã–ã„ã¾ã™ã€‚
            ãŠå®¢æ§˜ã«ãŠã‹ã‚Œã¾ã—ã¦ã¯ã€ä»Šã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã¾ã™ã‚ˆã†ã€ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

            [æ¬¡å›ã”é€£çµ¡æ—¥ç¨‹]
            {{nextNC_XL}} ã¾ã§ã«ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚
            å¼•ãç¶šãã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

            ä¸‹è¨˜ãŒã€æœ¬ãŠå•ã„åˆã‚ã›ã®å¯¾å¿œãƒ¡ãƒ³ãƒãƒ¼ã¨ãªã‚Šã¾ã™ã€‚
            å¯¾å¿œä¸­ã®ã”è³ªå•ã‚„ã”é€£çµ¡ã«ã‚ãŸã£ã¦ã¯ã€æœ¬ãƒ¡ãƒ¼ãƒ«ã«å…¨å“¡è¿”ä¿¡ã„ãŸã ãã‹ã€æ‹…å½“ã¾ã§ãŠé›»è©±ãã ã•ã„ã€‚
            ----------------------------------------
            {{agentAndLeaders}}
            ----------------------------------------
        </noscript>

        <noscript data-name="emailTo">
            {{mailTo}}
        </noscript>

        <noscript data-name="emailCc">
            {{mailCc}}
        </noscript>

        <noscript data-name="reviewRequest">
            @ ã•ã‚“ã€ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
            TL review ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            [{{Lic_L}}] {{caseNum}} {{caseTitle}}
            QuickACKã§ã™ã€‚ (SLA: {{SLA}})
        </noscript>

        <script>
            (function () {
                const divId = '#quick-ack_step2-<%=uid%>';
                const $scope = $(divId); // ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ç¯„å›²å†…ã ã‘ã§æ¢ã™
                const $emailHead = $scope.find('textarea[name="emailHead"]');
                const $emailBody = $scope.find('textarea[name="emailBody"]');
                const $emailTo = $scope.find('input[name="emailTo"]');
                const $emailCc = $scope.find('input[name="emailCc"]');
                const $emailSubject = $scope.find('input[name="emailSubject"]');
                const $reviewRequest = $scope.find('textarea[name="reviewRequest"]');

                const emailHeadText = $scope.find('noscript[data-name="emailHead"]').text().trim().replace(/\n +/g, '\n');
                const emailBodyText = $scope.find('noscript[data-name="emailBody"]').text().trim().replace(/\n +/g, '\n');
                const emailSubjectText = $scope.find('noscript[data-name="emailSubject"]').text().trim().replace(/\n +/g, '\n');
                const emailToText = $scope.find('noscript[data-name="emailTo"]').text().trim().replace(/\n +/g, '\n');
                const emailCcText = $scope.find('noscript[data-name="emailCc"]').text().trim().replace(/\n +/g, '\n');
                const reviewRequestText = $scope.find('noscript[data-name="reviewRequest"]').text().trim().replace(/\n +/g, '\n');

                const caseData = window.currentCase;
                const activeStep = caseData?.activeStep;

                if (activeStep && activeStep.emailHead) {
                    $emailHead.val(activeStep.emailHead);
                } else {
                    const renderedEmailHead = caseData.render(emailHeadText);
                    $emailHead.val(renderedEmailHead);
                }
                if (activeStep && activeStep.emailBody) {
                    $emailBody.val(activeStep.emailBody);
                } else {
                    const renderedEmailBody = caseData.render(emailBodyText);
                    $emailBody.val(renderedEmailBody);
                }
                if (activeStep && activeStep.emailTo) {
                    $emailTo.val(activeStep.emailTo);
                } else {
                    const renderedEmailTo = caseData.render(emailToText);
                    $emailTo.val(renderedEmailTo);
                }
                if (activeStep && activeStep.emailCc) {
                    $emailCc.val(activeStep.emailCc);
                } else {
                    const renderedEmailCc = caseData.render(emailCcText);
                    $emailCc.val(renderedEmailCc);
                }
                if (activeStep && activeStep.emailSubject) {
                    $emailSubject.val(activeStep.emailSubject);
                } else {
                    const renderedEmailSubject = caseData.render(emailSubjectText);
                    $emailSubject.val(renderedEmailSubject);
                }
                if (activeStep && activeStep.reviewRequest) {
                    $reviewRequest.val(activeStep.reviewRequest);
                } else {
                    const renderedReviewRequest = caseData.render(reviewRequestText);
                    $reviewRequest.val(renderedReviewRequest);
                }

                // .on ã§ã¯ãªãã€ç›´æ¥è¦ç´ ã« .click ç­‰ã§ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹
                $scope.find('button[title="ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°"]').off('click').on('click', function () {
                    const emailHeadText = $scope.find('textarea[name="emailHead"]').val();
                    const emailBodyText = $scope.find('textarea[name="emailBody"]').val();
                    const emailSubjectText = $scope.find('input[name="emailSubject"]').val();
                    const reviewRequestText = $scope.find('textarea[name="reviewRequest"]').val();

                    const renderedEmailHead = caseData.render(emailHeadText);
                    const renderedEmailBody = caseData.render(emailBodyText);
                    const renderedEmailSubject = caseData.render(emailSubjectText);
                    const renderedReviewRequest = caseData.render(reviewRequestText);

                    $emailHead.val(renderedEmailHead);
                    $emailBody.val(renderedEmailBody);
                    $emailSubject.val(renderedEmailSubject);
                    $reviewRequest.val(renderedReviewRequest);

                    console.log('emailHead', renderedEmailHead, 'emailBody', renderedEmailBody, 'emailSubject', renderedEmailSubject, 'reviewRequest', renderedReviewRequest);
                });

                $scope.find('button[title="ãƒªã‚»ãƒƒãƒˆ"]').off('click').on('click', function () {
                    if (!confirm('ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                        return;
                    }

                    const renderedEmailHead = caseData.render(emailHeadText);
                    const renderedEmailBody = caseData.render(emailBodyText);
                    const renderedEmailSubject = caseData.render(emailSubjectText);
                    const renderedReviewRequest = caseData.render(reviewRequestText);

                    $scope.find('textarea[name="emailHead"]').val(renderedEmailHead);
                    $scope.find('textarea[name="emailBody"]').val(renderedEmailBody);
                    $scope.find('input[name="emailSubject"]').val(renderedEmailSubject);
                    $scope.find('textarea[name="reviewRequest"]').val(renderedReviewRequest);
                    $scope.find('input[name="emailTo"]').val('');
                    $scope.find('input[name="emailCc"]').val('');
                });

                $scope.find('button[title="ãƒ¡ãƒ¼ãƒ«ä½œæˆ"]').off('click').on('click', function () {
                    const emailHead = $scope.find('textarea[name="emailHead"]').val();
                    const emailBody = $scope.find('textarea[name="emailBody"]').val();
                    const emailTo = $scope.find('input[name="emailTo"]').val();
                    const emailCc = $scope.find('input[name="emailCc"]').val();
                    const emailSubject = $scope.find('input[name="emailSubject"]').val();
                    const reviewRequest = $scope.find('textarea[name="reviewRequest"]').val();

                    const separator = '\n\n========================================\n\n';
                    const emailContent = `${emailHead}${separator}${emailBody}`;
                    const emailUrl = `mailto:${emailTo}?cc=${emailCc}&subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailContent)}`;
                    window.open(emailUrl, '_blank');
                });
            })();
        </script>
    </div>